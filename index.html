<script>
  /* ===== ここから貼り替え ===== */

  // 判定の基本設定（そのまま）
  const MACRO_KEYWORDS = ["マクロ"];
  const AUTO_RESET_MS  = 10000;

  // 画像/音声をフォルダに入れたら "assets/" などに
  const ASSET_BASE = "";

  // ★キャッシュ破り用のバージョン（数字を増やすと確実に更新されます）
  const VERSION = "20250919-2";
  const BUST = "?v=" + VERSION;

  // 画像候補を全部並べておく（存在したものに自動で切替）
  const FILES_ALL = {
    idle:  [
      "fairy_idle.png.png",   // いまの名前
      "fairy_idle.png",       // 将来リネームしたとき
      "ChatGPT Image 2025年9月19日 13_29_59.png" // 旧ファイル名
    ],
    smile: [
      "fairy_smile.png.png",
      "fairy_smile.png",
      "ChatGPT Image 2025年9月19日 13_30_03.png"
    ],
    angry: [
      "fairy_angry.png.png",
      "fairy_angry.png",
      "ChatGPT Image 2025年9月19日 13_30_08.png"
    ],
  };

  // 音声（置いてあれば使われます）
  const PRESET_OK_AUDIO = ASSET_BASE + "success.mp3";
  const PRESET_NG_AUDIO = ASSET_BASE + "fail.mp3";

  // 要素取得
  const inputEl  = document.getElementById("answer");
  const resultEl = document.getElementById("result");
  const fairy    = document.getElementById("fairy");
  const okAudio  = document.getElementById("okAudio");
  const ngAudio  = document.getElementById("ngAudio");
  const okFile   = document.getElementById("okFile");
  const ngFile   = document.getElementById("ngFile");
  const confetti = document.getElementById("confetti");
  const ctx      = confetti.getContext("2d");

  // 画像をフォールバックしながら設定（+キャッシュ破り）
  function setImgFromList(el, nameList) {
    // 先頭から順に試す（ASSET_BASE を付け、BUST でキャッシュ回避）
    const cands = nameList.map(n => ASSET_BASE + n).map(u => u + BUST);
    let i = 0;
    const tryNext = () => {
      el.onerror = () => { i++; if (i < cands.length) tryNext(); };
      el.src = cands[i];
    };
    tryNext();
  }

  // 画像プリロード（体感のチラつき防止）
  [...new Set([...FILES_ALL.idle, ...FILES_ALL.smile, ...FILES_ALL.angry])]
    .forEach(n => { const im = new Image(); im.src = ASSET_BASE + n + BUST; });

  // 音声（あれば再生される）
  if (PRESET_OK_AUDIO) okAudio.src = PRESET_OK_AUDIO + BUST;
  if (PRESET_NG_AUDIO) ngAudio.src = PRESET_NG_AUDIO + BUST;
  okFile?.addEventListener("change", e => { const f=e.target.files?.[0]; if(f) okAudio.src=URL.createObjectURL(f); });
  ngFile?.addEventListener("change", e => { const f=e.target.files?.[0]; if(f) ngAudio.src=URL.createObjectURL(f); });

  // 見やすいように背景キャンバス
  const resize = ()=>{ confetti.width = innerWidth; confetti.height = innerHeight; };
  addEventListener("resize", resize); resize();

  function launchConfetti(){
    const parts = Array.from({length: 150}, () => ({
      x: Math.random()*confetti.width, y: -10,
      w: 5, h: 10,
      color: `hsl(${Math.random()*360},100%,70%)`,
      speed: 2+Math.random()*4, rot: Math.random()*360, rv: -3+Math.random()*6
    }));
    const tick = () => {
      ctx.clearRect(0,0,confetti.width,confetti.height);
      parts.forEach(p=>{
        ctx.save(); ctx.translate(p.x,p.y); ctx.rotate(p.rot*Math.PI/180);
        ctx.fillStyle=p.color; ctx.fillRect(-p.w/2,-p.h/2,p.w,p.h);
        ctx.restore(); p.y+=p.speed; p.rot+=p.rv;
      });
      if (parts.some(p=>p.y<confetti.height)) requestAnimationFrame(tick);
    };
    tick();
  }

  // 入力正規化
  const normalize = s =>
    s.trim().toLowerCase()
     .replace(/\u3000/g," ")
     .replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0));

  /* === 表情＆動き === */
  function setFairyIdle(){
    fairy.classList.remove("flying");
    setImgFromList(fairy, FILES_ALL.idle);
    fairy.style.left = "auto"; fairy.style.right = "8%";
    fairy.style.top  = "50%";  fairy.style.transform = "translate(0,-50%)";
  }
  function setFairySmileFly(){
    setImgFromList(fairy, FILES_ALL.smile);
    fairy.classList.add("flying");
    fairy.style.left="50%"; fairy.style.right="auto"; fairy.style.top="50%";
  }
  function setFairyAngryStay(){
    fairy.classList.remove("flying");
    setImgFromList(fairy, FILES_ALL.angry);
    fairy.style.left="auto"; fairy.style.right="8%";
    fairy.style.top="50%"; fairy.style.transform="translate(0,-50%)";
  }

  /* === 判定＆自動リセット === */
  let resetTimer = null;
  function judge(){
    clearTimeout(resetTimer);
    const ok = MACRO_KEYWORDS.map(k=>normalize(k)).includes(normalize(inputEl.value));

    if (ok){
      resultEl.innerHTML = "大正解！みんなをもとの大きさに戻してあげる<br><span class='small'>※これで脱出ゲームは終了です。出口からおかえりください。</span>";
      resultEl.className = "msg ok";
      setFairySmileFly();
      okAudio.currentTime = 0; okAudio.play().catch(()=>{});
      launchConfetti();
    } else {
      resultEl.innerHTML = "残念。不正解。また挑戦してね。ばいばい。<br><span class='small'>※もう一度謎解きをしてみてください。ギブアップするときには出口から出てかまいません。</span>";
      resultEl.className = "msg ng";
      setFairyAngryStay();
      ngAudio.currentTime = 0; ngAudio.play().catch(()=>{});
    }
    resetTimer = setTimeout(resetAll, AUTO_RESET_MS);
  }

  function resetAll(){
    clearTimeout(resetTimer);
    inputEl.value = ""; resultEl.textContent = ""; resultEl.className = "msg";
    setFairyIdle(); ctx.clearRect(0,0,confetti.width,confetti.height);
    inputEl.focus();
  }

  // 初期化
  document.getElementById("judgeBtn").addEventListener("click", judge);
  inputEl.addEventListener("keydown", e=>{ if(e.key==="Enter") judge(); });
  setFairyIdle(); inputEl.focus();

  /* ===== ここまで貼り替え ===== */
</script>
