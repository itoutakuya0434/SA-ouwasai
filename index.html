<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>脱出ゲーム 正誤判定</title>
<style>
  :root{ --panel:rgba(255,255,255,.06); --border:rgba(255,255,255,.12);
         --ok:#34d399; --ng:#f87171; }
  *{box-sizing:border-box}
  html,body{height:100%; margin:0; color:#fff;
    font-family:system-ui,-apple-system,"Segoe UI",Roboto,"Hiragino Kaku Gothic ProN","Yu Gothic",sans-serif;}
  /* 幻想背景＋きらめき */
  body{
    background:
      radial-gradient(1100px 550px at 10% -10%, #60a5fa22, transparent 60%),
      radial-gradient(900px 450px at 110% 0%, #a78bfa22, transparent 60%),
      radial-gradient(600px 600px at 50% 120%, #22d3ee20, transparent 60%),
      linear-gradient(#0b1220, #0e172a 40%, #111827);
    overflow:hidden;
  }
  .twinkle,.twinkle::after{
    position:fixed; inset:0; pointer-events:none; content:"";
    background:
      radial-gradient(2px 2px at 20% 30%, #fff8, transparent 60%),
      radial-gradient(1.5px 1.5px at 60% 20%, #fff6, transparent 60%),
      radial-gradient(1.8px 1.8px at 80% 70%, #fff7, transparent 60%),
      radial-gradient(1.4px 1.4px at 35% 80%, #fff5, transparent 60%),
      radial-gradient(1.6px 1.6px at 75% 45%, #fff7, transparent 60%);
    animation: shimmer 6s ease-in-out infinite; z-index:1;
  }
  .twinkle::after{ animation-delay:3s; opacity:.7 }
  @keyframes shimmer { 0%,100%{opacity:.35} 50%{opacity:.8} }

  /* UI */
  .grid{height:100%; display:grid; place-items:center; padding:16px; position:relative; z-index:2;}
  .card{
    width:min(720px,92vw);
    background:var(--panel); border:1px solid var(--border);
    border-radius:20px; padding:20px 20px 16px; backdrop-filter: blur(6px);
  }
  h1{margin:0 0 12px; font-size:clamp(20px,3vw,28px); display:flex; gap:10px; align-items:center}
  .dot{height:10px;width:10px;border-radius:50%; background:#10b981; box-shadow:0 0 10px #10b981aa}
  .row{display:grid; grid-template-columns:1fr auto; gap:10px}
  input[type="text"]{
    width:100%; padding:14px 16px; border-radius:12px; border:1px solid var(--border);
    background:#0b1220cc; color:#fff; outline:none; font-size:18px;
  }
  button{border:none; border-radius:12px; padding:12px 16px; font-weight:600; cursor:pointer;
    background:#10b981; color:#fff; font-size:16px;}

  .msg{margin:14px 2px 0; font-size:18px; font-weight:700}
  .ok{color:var(--ok)} .ng{color:var(--ng)}
  .small{font-size:12px; opacity:.85}
  .toolbar{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}

  /* 紙吹雪 */
  .confetti{position:fixed; inset:0; pointer-events:none; z-index:6}

  /* 妖精（画像3枚） */
  .stage{position:fixed; inset:0; pointer-events:none; z-index:5}
  .fairy{
    position:fixed; top:50%; right:8%; transform:translate(0,-50%); /* 初期＝右中央で静止 */
    width:min(200px,30vw); filter:drop-shadow(0 0 10px #ffffff90);
  }
  /* 正解＝画面を飛び回る（画像は差し替え、動きはCSS） */
  .flying{ left:50% !important; right:auto !important; animation: fly 7s linear infinite }
  @keyframes fly{
    0%{ transform: translate(-50%, -50%) rotate(0deg) }
    25%{ transform: translate(calc(-50% + 32vw), calc(-50% - 16vh)) rotate(16deg) }
    50%{ transform: translate(calc(-50% + 6vw),  calc(-50% + 22vh)) rotate(-12deg) }
    75%{ transform: translate(calc(-50% - 28vw), calc(-50% - 12vh)) rotate(10deg) }
    100%{ transform: translate(-50%, -50%) rotate(0deg) }
  }
</style>
</head>
<body>
  <div class="twinkle"></div>

  <!-- 紙吹雪 -->
  <canvas id="confetti" class="confetti"></canvas>

  <!-- 妖精（画像3枚） -->
  <div class="stage" aria-hidden="true">
    <!-- 初期も .png.png を参照 -->
    <img id="fairy" class="fairy" src="fairy_idle.png.png" alt="fairy">
  </div>

  <!-- UI -->
  <div class="grid">
    <div class="card">
      <h1><span class="dot"></span>脱出ゲーム 正誤判定</h1>
      <div class="row">
        <input id="answer" type="text" placeholder="キーワードを入力…" />
        <button id="judgeBtn">判定</button>
      </div>
      <div id="result" class="msg" aria-live="polite"></div>

      <!-- 任意：当日その場で音声を読み込みたい場合だけ使う -->
      <div class="toolbar small">
        <span>（任意）音声ファイル選択：</span>
        <label>正解 <input type="file" id="okFile" accept="audio/*"></label>
        <label>不正解 <input type="file" id="ngFile" accept="audio/*"></label>
      </div>
    </div>
  </div>

  <audio id="okAudio" preload="auto"></audio>
  <audio id="ngAudio" preload="auto"></audio>

<script>
  /* ===== 基本設定 ===== */
  const MACRO_KEYWORDS = ["マクロ"];       // 正解ワード
  const AUTO_RESET_MS   = 10000;           // 10秒で自動リセット
  const ASSET_BASE      = "";              // フォルダに入れたら "assets/" などを指定

  // いまの実ファイル名（.png.png）に合わせた参照
  const FILES = {
    idle:  ASSET_BASE + "fairy_idle.png.png",
    smile: ASSET_BASE + "fairy_smile.png.png",
    angry: ASSET_BASE + "fairy_angry.png.png",
  };

  // 将来 .png に直したり、ChatGPT Image…名が残っていても動くフォールバック
  const FALLBACKS = {
    idle:  [ASSET_BASE + "fairy_idle.png",
            ASSET_BASE + "ChatGPT Image 2025年9月19日 13_29_59.png"],
    smile: [ASSET_BASE + "fairy_smile.png",
            ASSET_BASE + "ChatGPT Image 2025年9月19日 13_30_03.png"],
    angry: [ASSET_BASE + "fairy_angry.png",
            ASSET_BASE + "ChatGPT Image 2025年9月19日 13_30_08.png"],
  };

  // 音声（置いた場合だけ自動再生）
  const PRESET_OK_AUDIO = ASSET_BASE + "success.mp3";
  const PRESET_NG_AUDIO = ASSET_BASE + "fail.mp3";

  /* ===== 要素 ===== */
  const inputEl   = document.getElementById("answer");
  const resultEl  = document.getElementById("result");
  const fairy     = document.getElementById("fairy");
  const okAudio   = document.getElementById("okAudio");
  const ngAudio   = document.getElementById("ngAudio");
  const okFile    = document.getElementById("okFile");
  const ngFile    = document.getElementById("ngFile");
  const confetti  = document.getElementById("confetti");
  const ctx       = confetti.getContext("2d");

  // プリロード（チラつき防止）
  [...new Set([FILES.idle, FILES.smile, FILES.angry,
    ...FALLBACKS.idle, ...FALLBACKS.smile, ...FALLBACKS.angry])]
    .filter(Boolean)
    .forEach(src => { const i=new Image(); i.src=src; });

  // 音声の初期化（存在すれば使われる）
  if (PRESET_OK_AUDIO) okAudio.src = PRESET_OK_AUDIO;
  if (PRESET_NG_AUDIO) ngAudio.src = PRESET_NG_AUDIO;
  okFile?.addEventListener("change", e => { const f=e.target.files?.[0]; if(f) okAudio.src=URL.createObjectURL(f); });
  ngFile?.addEventListener("change", e => { const f=e.target.files?.[0]; if(f) ngAudio.src=URL.createObjectURL(f); });

  /* ===== ユーティリティ ===== */
  const normalize = s =>
    s.trim().toLowerCase()
     .replace(/\u3000/g," ")
     .replace(/[Ａ-Ｚａ-ｚ０-９]/g, ch => String.fromCharCode(ch.charCodeAt(0)-0xFEE0));

  const resize = ()=>{
